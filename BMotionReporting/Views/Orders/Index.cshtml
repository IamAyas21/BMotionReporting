@model BMotionReporting.Models.OrderModels
@{
    ViewBag.Title = "Pengambilan BBM";
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-warning" style="margin:10px">
        <p><i class="fa fa-warning"></i> @TempData["Error"].ToString()</p>
    </div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success" style="margin:10px">
        <strong>Success!</strong> @TempData["Success"].ToString()
    </div>
}
<h1><strong style="font-family:Arial">Pengambilan BBM</strong></h1>
<div class="card card-primary" style="width:50%">
    <div class="card-body">
        <div class="row">
            <div class="col-lg-12">
                @*<h3 class="card-title">QR Code Scanner</h3>*@
                <div  style="width: max-content;background-color: #007bff;color: white;padding: 0.5rem 0.6rem;font-weight: bold;border-radius: 8px;">
                    <img src="~/Assets/icon scan.png" style="height:1.5rem;" />
                    Scan QR Code
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <video id="preview" width="500" height="500"></video>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="modalStruk"
     data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <button type="button" class="close" data-dismiss="modal">
                    <i class="fa fa-fw fa-close"></i>
                </button>
                <div id="data">
                    <div><h2 class="text-center"><strong style="font-family:Arial">Struk Pengambilan BBM</strong></h2><hr /><h1 class="text-center">SPBU 34.413.55</h1>
                        <div class="row"><div class="col-md-4 text-right"><h4>Premium</h4></div><div class="col-md-4 text-center"><h4>200 Lt</h4></div><div class="col-md-4"><h4>10.00</h4></div></div>
                        <div class="row"><div class="col-md-3"></div><div class="col-md-6 text-center"></div><div class="col-md-3"></div></div><h3 style="font-weight:bold">syarat & ketentuan</h3><p class="text-justify">Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged.</p><hr /></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="cetakOrder" onclick="printDiv('#data');" class="btn btn-primary button button4">
                    Cetak
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="modalOrder"
     data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2><strong style="font-family:Arial">Order BBM</strong></h2>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <div id="fuelForm"></div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="OrderFuel()" class="btn btn-primary button button4">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>
<style>
    .divCode img{
        position: relative;
        left: 50%;
        transform: translateX(-25%);
    }
</style>
<script type="text/javascript">

    var fuelLength = 0;
    //$("#modalStruk").modal('show');
    let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
    scanner.addListener('scan', function (content) {
        //scanner.stop();
        ShowStruck(content);
    });

    //function toggleScan()
    //{
    //    scanner.
    //}
    function printDiv(elem) {
        renderMe($('<div/>').append($(elem).clone()).html());
    }

    function renderMe(data) {
        var mywindow = window.open('', 'Struk Pengambilan', 'height=1000,width=1000');
        mywindow.document.write('<html><head><title>Struk Pengambilan BBM</title>');
        mywindow.document.write('<link href="Content/AdminLTE/adminlte.min.css" rel="stylesheet" />');
        mywindow.document.write('<link href="~/Content/bootstrap.min.css" rel="stylesheet" />');
        mywindow.document.write('<style>.divCode img{position: relative;left: 50%;transform: translateX(-25%);}</style>');
        mywindow.document.write('</head><body >');
        mywindow.document.write(data);
        mywindow.document.write('</body></html>');


        setTimeout(function () {
            mywindow.print();
            mywindow.close();
        }, 1000)
        return true;
    }

    function ShowStruck(orderNo) {
        debugger;
        $.ajax({
            type: "POST",
            url: "@Url.Action("StrukBBM", "Orders")",
            data: { orderNo: orderNo },
            success: function (response) {
                console.log(response);
                if (response == "OK"){
                    alert("Pembelian BBM telah berhasil terverifikasi");
                }
                else if (response == "Failed") {
                    alert("Data tidak dapat dikenali.");
                }
                else 
                {
                    var _html = "";
                    $(response).each(function (index, data) {
                        _html += "<div><h2 class=\"text-center\"><strong style=\"font-family:Arial\">Struk Pengambilan BBM</strong></h2><hr /><h1 class=\"text-center\">SPBU 34.413.55</h1>"
                        _html += "<div class=\"row\"><div class=\"col-md-4 text-right\"><h4>" + data.FuelName + "</h4></div><div class=\"col-md-4 text-center\"><h4>" + data.Liter + " Lt</h4></div><div class=\"col-md-4\"><h4>" + data.CreatedDate + "</h4></div></div>";
                        _html += "<div class=\"row\"><div class=\"col-md-3\"></div><div class=\"divCode\" id=\"qr" + index + "\"></div><div class=\"col-md-3\"></div></div><h3 style=\"font-weight:bold\">syarat & ketentuan</h3><ol><li>Struk Pengambilan BBM berlaku untuk 1 (satu) kali pengambilan BBM;</li><li>Struk Pengambilan BBM berlaku hanya pada tanggal saat struk tersebut ;</li><li>Jika Struk Pengambilan BBM rusak atau hilang, silahkan menghubungi Admin di SPBU tersebut.</li><li>Berikan Struk Pengambilan BBM tersebut kepada petugas saat hendak melakukan pengisian BBM;</li><li>Syarat &amp; Ketentuan sewaktu-waktu dapat berubah.</li></ol></div>"
                    });
                    document.getElementById("data").innerHTML = _html;

                    $(response).each(function (index, data) {
                        var id = data.OrderDetailId;
                        console.log(id);
                        var qrcode = new QRCode("qr" + index);
                        qrcode.makeCode(id.toString());
                    });
                    $("#modalStruk").modal('show');
                }
                //else {
                //    document.getElementById('fuelForm').innerHTML = "";
                //    document.getElementById('fuelForm').innerHTML += "<div class=\"row\">" +
                //            "<div class=\"col-lg-4\" align=\"left\">NIP</div><div class=\"col-lg-8\"><label id=\"nip_0\" style=\"color:black\">" + response[0].NIP + "</label></div>";
                //    for (var i = 0; i < response.length; i++) {
                //        fuelLength++;
                //        document.getElementById('fuelForm').innerHTML += "<div class=\"row\">" +
                //            "<div class=\"col-lg-4\" align=\"left\"><label id=\"fuelId_" + i + "\" value=\"" + response[i].FuelId + "\" style=\"color:black\">" + response[i].FuelName + "</label></div>" +
                //            "<div class=\"col-lg-8\" align=\"left\"><input id=\"liter_" + i + "\" class=\"form-control\" maxlength=\"3\" onkeypress=\"return IsNumeric(event);\"></div></div>";
                //    }
                //    $("#modalOrder").modal('show');
                //}
            },
            error: function (response) {
                //alert(response)
            }
        });
    }

    function OrderFuel() {
        var fuel = [];
        var nip = "";
        var fuelId = "";
        var liter = "";

        for (var i = 0; i < fuelLength; i++) {
            if ($('#liter_' + i).val() != undefined && $('#liter_' + i).val() != "") {
                if (nip == "") {
                    nip = document.getElementById('nip_0').innerText;
                    fuelId = i + 1;
                    liter = $('#liter_' + i).val();
                }
                else {
                    var ii = i + 1;
                    nip += "," + document.getElementById('nip_0').innerText;
                    fuelId += "," + ii;
                    liter += "," + $('#liter_' + i).val();
                }

                fuel = [nip, fuelId, liter];
            }
        }

        $.ajax(
              {
                  type: "POST",
                  url: "@Url.Action("OrderFuel", "Orders")",
                  data: { arrValue: fuel },
                  success: function (response) {
                      $("#modalOrder").modal('hide');
                      ShowStruck(response.OrderNo);
                  },
                  error: function (response) {
                      //alert(response)
                  }
              });
    }

    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            scanner.start(cameras[0]);
        }
        else {
            console.error('No camera found');
        }
    }).catch(function (e) {
        console.error(e);
    });

    var specialKeys = new Array();
    specialKeys.push(8);
    function IsNumeric(e) {
        var keyCode = e.which ? e.which : e.keyCode
        var ret = ((keyCode >= 48 && keyCode <= 57) || specialKeys.indexOf(keyCode) != -1);
        //document.getElementById("error").style.display = ret ? "none" : "inline";
        return ret;
    }
</script>