@model BMotionReporting.Models.OrderModels
@{
    ViewBag.Title = "Pengambilan BBM";
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-warning" style="margin:10px">
        <p><i class="fa fa-warning"></i> @TempData["Error"].ToString()</p>
    </div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success" style="margin:10px">
        <strong>Success!</strong> @TempData["Success"].ToString()
    </div>
}

<h1><strong style="font-family:Arial">Pengambilan BBM</strong></h1>

<div class="card card-primary" style="width:50%">
    <div class="card-body">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="card-title">QR Code Scanner</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <video id="preview" width="500" height="500"></video>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="modalStruk"
     data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2><strong style="font-family:Arial">Struk Pengambilan BBM</strong></h2>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <div id="divOutlet" style="display:none"></div>
                <div id="divOrder" style="display:none"></div>
                <div id="divFooter" style="display:none"></div>
                <div id="result"></div>
                @*<div id="struk"></div>
                <div id="qrcode"></div>*@

                @*<div class="row" align="center">
                    <div class="col-lg-12">
                        <h2 id="outletNo"><strong>SPBU 34.413.55</strong></h2>
                        <h3 id="outletName"><strong>Batujaya</strong></h3>
                    </div>
                </div>*@
               
                @*<div class="row" style="margin:2%">
                    <div class="col-lg-6">
                        <div id="orderDetail"></div>
                    </div>
                    <div class="col-lg-6">
                        <div id="qrcode"></div>
                    </div>
                </div>*@
                @*<div class="row" style="margin:2%">
                    <div class="col-lg-12">
                        <h6><strong>syarat & ketentuan</strong></h6>
                        <p><small>dmsfnds dsdsk fsdf fsdfds fsdfsd fsdf sfsf dsfs dfsd fs f sd</small></p>
                    </div>
                </div>*@
            </div>
            <div class="modal-footer">
                <button type="button" id="cetakOrder" class="btn btn-primary button button4">
                    Cetak
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" tabindex="-1" id="modalOrder"
     data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2><strong style="font-family:Arial">Order BBM</strong></h2>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <div id="fuelForm"></div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="OrderFuel()" class="btn btn-primary button button4">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var fuelLength = 0;

    let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
    scanner.addListener('scan', function (content) {
        ShowStruck(content);
    });

    function ShowStruck(orderNo) {
        $.ajax({
            type: "POST",
            url: "@Url.Action("StrukBBM", "Orders")",
            data: { orderNo: orderNo },
            success: function (response) {
                //document.getElementById('struk').innerHTML = "";
                //document.getElementById('qrcode').innerHTML = "";
                for (var i = 0; i < 1; i++) {
                    if (response[i].OutletNo != undefined) {
                        debugger
                        document.getElementById('divOutlet').innerHTML = "<div class=\"row\" align=\"center\">" +
                        "<div class=\"col-lg-12\"><h2><strong>" + response[i].OutletNo + "</strong></h2>" +
                        "<h3><strong>" + response[i].OutletName + "</strong></h3></div></div>";
                        
                        document.getElementById('divOrder').innerHTML = "<div class=\"row\" style=\"margin:2%\">" +
                        "<div class=\"col-lg-6\"><div class=\"row\"><div class=\"col-lg-5\" align=\"left\"><strong><label style=\"color:black\">" + response[i].FuelName +
                        "</label></strong></div><div class=\"col-lg-2\" align=\"left\"><label style=\"color:black\">" + response[i].Liter + " Ltr</label></div>" +
                        "<div class=\"col-lg-5\" align=\"left\"><label style=\"color:black\">" + response[i].CreatedDate + "</label></div></div></div>" +
                        "<div class=\"col-lg-6\">" +
                        "<div id=\"qrcode_"+i+"\"></div></div>";

                        document.getElementById('divFooter').innerHTML = "<div class=\"row\" style=\"margin:2%\">"+
                        "<div class=\"col-lg-12\"><h6><strong>syarat & ketentuan</strong></h6>"+
                        "<p><small>dmsfnds dsdsk fsdf fsdfds fsdfsd fsdf sfsf dsfs dfsd fs f sd</small></p></div></div>";

                        makeCode("qrcode_" + i, response[i].OrderDetailId);
                        document.getElementById('result').innerHTML += document.getElementById('divOutlet').innerHTML + document.getElementById('divOrder').innerHTML + document.getElementById('divFooter').innerHTML;

                        //document.getElementById('outletNo').innerHTML = response[i].OutletNo;
                        //document.getElementById('outletName').innerHTML = response[i].OutletName;
                        //makeCode(response[i].OrderNo);
                        
                      //  document.getElementById('qrcode').innerHTML = "<div id=\"qrcode_" + i + "\"></div>";
                      //  var divQRCode = makeCode("qrcode_" + i, response[i].OrderDetailId);
                      //  document.getElementById('struk').innerHTML += "<div class=\"row\" align=\"center\">" +
                      //"<div class=\"col-lg-12\"><h2><strong>" + response[i].OutletNo + "</strong></h2>" +
                      //"<h3 id=\"outletName" + i + "\"><strong>" + response[i].OutletName + "</strong></h3></div></div>" +
                      //"<div class=\"row\" style=\"margin:2%\"><div class=\"col-lg-6\">" + divQRCode + "</div></div>" +
                      //"<div class=\"col-lg-2\" align=\"left\"><strong><label style=\"color:black\">" + response[i].FuelName + "</label></strong></div></div>" +
                      //"<div class=\"col-lg-2\" align=\"left\"><label style=\"color:black\">" + response[i].Liter + " Ltr</label></div>" +
                      //"<div class=\"col-lg-2\" align=\"left\"><label style=\"color:black\">" + response[i].CreatedDate + "</label></div></div></div>" +
                      //"<div class=\"row\" style=\"margin:2%\"><div class=\"col-lg-12\"><h6><strong>syarat & ketentuan</strong></h6>" +
                      //"<p><small>dmsfnds dsdsk fsdf fsdfds fsdfsd fsdf sfsf dsfs dfsd fs f sd</small></p></div></div>";

                        //document.getElementById('orderDetail').innerHTML = "";
                        //for (var k = 0; k < response[i].StruckOrderDetails.length; k++) {
                        //    document.getElementById('orderDetail').innerHTML += "<div class=\"row\">" +
                        //        "<div class=\"col-lg-5\" align=\"left\"><strong><label style=\"color:black\">" + response[i].StruckOrderDetails[k].FuelName + "</label></strong></div>" +
                        //        "<div class=\"col-lg-2\" align=\"left\"><label style=\"color:black\">" + response[i].StruckOrderDetails[k].Liter + " Ltr</label></div>" +
                        //        "<div class=\"col-lg-5\" align=\"left\"><label style=\"color:black\">" + response[i].StruckOrderDetails[k].CreatedDate + "</label></div></div>";
                        //    $("#modalStruk").modal('show');
                        //}
                    }
                    else {
                        document.getElementById('fuelForm').innerHTML = "";
                        document.getElementById('fuelForm').innerHTML += "<div class=\"row\">" +
                                "<div class=\"col-lg-4\" align=\"left\">NIP</div><div class=\"col-lg-8\"><label id=\"nip_0\" style=\"color:black\">" + response[0].NIP + "</label></div>";
                        for (var i = 0; i < response.length; i++) {
                            fuelLength++;
                            document.getElementById('fuelForm').innerHTML += "<div class=\"row\">" +
                                "<div class=\"col-lg-4\" align=\"left\"><label id=\"fuelId_" + i + "\" value=\"" + response[i].FuelId + "\" style=\"color:black\">" + response[i].FuelName + "</label></div>" +
                                "<div class=\"col-lg-8\" align=\"left\"><input id=\"liter_" + i + "\" class=\"form-control\" maxlength=\"3\" onkeypress=\"return IsNumeric(event);\"></div></div>";
                        }
                        $("#modalOrder").modal('show');
                    }
                    
                }
                $("#modalStruk").modal('show');
            },
            error: function (response) {
                //alert(response)
            }
        });
    }

    function OrderFuel() {
        var fuel = [];
        var nip = "";
        var fuelId = "";
        var liter = "";

        for (var i = 0; i < fuelLength; i++) {
            if ($('#liter_' + i).val() != undefined && $('#liter_' + i).val() != "") {
                if (nip == "") {
                    nip = document.getElementById('nip_0').innerText;
                    fuelId = i + 1;
                    liter = $('#liter_' + i).val();
                }
                else {
                    var ii = i + 1;
                    nip += "," + document.getElementById('nip_0').innerText;
                    fuelId += "," + ii;
                    liter += "," + $('#liter_' + i).val();
                }

                fuel = [nip, fuelId, liter];
            }
        }
        
        $.ajax(
              {
                  type: "POST",
                  url: "@Url.Action("OrderFuel", "Orders")",
                  data: { arrValue: fuel },
                  success: function (response) {
                      $("#modalOrder").modal('hide');
                      ShowStruck(response.OrderNo);
                  },
                  error: function (response) {
                      //alert(response)
                  }
              });
    }

    function makeCode(id, orderNo) {
        debugger
        var qrcode = new QRCode(id);
        qrcode.makeCode(orderNo);
    }

    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            scanner.start(cameras[0]);
        }
        else {
            console.error('No camera found');
        }
    }).catch(function (e) {
        console.error(e);
    });

    var specialKeys = new Array();
    specialKeys.push(8);
    function IsNumeric(e) {
        var keyCode = e.which ? e.which : e.keyCode
        var ret = ((keyCode >= 48 && keyCode <= 57) || specialKeys.indexOf(keyCode) != -1);
        //document.getElementById("error").style.display = ret ? "none" : "inline";
        return ret;
    }
</script>
